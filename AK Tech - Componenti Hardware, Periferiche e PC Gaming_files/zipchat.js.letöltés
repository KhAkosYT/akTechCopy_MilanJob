(function() {
  if (window.zipchatWidgetLoaded) {
    return; // If already loaded, do not load again
  }

  // Track the current URL for SPA navigation detection
  let lastUrl = window.location.href;

  const typeBarAccentColor = '#717171';
  const typeBarGlowColors = '#FEE988, #ff7eb3, #8e54e9, #4776e6, #ff7eb3'
  const typeBarGlowOpacity = 0.2;

  // Function to handle URL changes in SPAs
  function handleUrlChange() {
    const currentUrl = window.location.href;
    if (currentUrl !== lastUrl) {
      lastUrl = currentUrl;

      // Clean up existing widget elements
      cleanupWidget();

      // Reload widget with the new URL
      loadWidget();

      // Re-setup URL change detection
      setupUrlChangeDetection();
    }
  }

  // Function to clean up the widget elements
  function cleanupWidget() {
    // Remove the iframe if it exists
    const iframe = document.getElementById('zipchat-iframe');
    if (iframe) {
      iframe.remove();
    }

    // Remove the chat container if it exists
    const container = document.getElementById('widget-chat-container');
    if (container) {
      container.remove();
    }

    // Clear the URL check interval if it exists
    if (window.zipchatUrlCheckInterval) {
      clearInterval(window.zipchatUrlCheckInterval);
      window.zipchatUrlCheckInterval = null;
    }

    // Reset the widget loaded flag
    window.zipchatWidgetLoaded = false;
  }

  // Set up URL change detection using non-invasive polling
  function setupUrlChangeDetection() {
    // Method 1: Listen for popstate event (back/forward navigation)
    window.addEventListener('popstate', handleUrlChange);

    // Method 2: Simple polling to check for URL changes (1000ms interval is responsive without being resource-intensive)
    const urlCheckInterval = setInterval(handleUrlChange, 1000);

    // Store the interval ID for cleanup
    window.zipchatUrlCheckInterval = urlCheckInterval;
  }

  function toggleBodyScroll(enable) {
    if (enable) {
      document.body.style.overflow = '';
    } else {
      document.body.style.overflow = 'hidden';
    }
  }

  function hideDotIconContent() {
    const button = document.getElementById('widget-chat-button');

    button.style.removeProperty('--dot-icon-content');
    button.style.removeProperty('--dot-icon-size');
    button.style.removeProperty('--dot-icon-right');
    button.style.removeProperty('--dot-icon-line-height');
    button.style.removeProperty('--dot-icon-display');
  }

  function setDotIconContent() {
    const body = document.querySelector('body');
    const widgetSize = getComputedStyle(body).getPropertyValue("--widget-size").trim();
    const widgetBubbleIconType = getComputedStyle(body).getPropertyValue("--widget-bubble-icon-type").trim();

    let right;

    if (widgetBubbleIconType === 'type_bar' || widgetSize === 'large') {
      right = `0%`;
    } else {
      right = `-4%`;
    }

    const button = document.getElementById('widget-chat-button');
    button.style.setProperty('--dot-icon-right', right);
    button.style.setProperty('--dot-icon-content', '"1"');
    button.style.setProperty('--dot-icon-line-height', '150%');
    button.style.setProperty('--dot-icon-size', '18px');
    button.style.setProperty('--dot-icon-display', 'block');
  }

  function handleIframe(iframe, chatBubbleContainer, chatTrigger, innerIcon, closeIcon, widgetData, smallScreen) {
    if (chatBubbleContainer.querySelector("#close-preview-message")) {
      chatBubbleContainer.querySelector('#close-preview-message').click()
      if (!!chatTrigger?.conversation_message){
        iframe.contentWindow.postMessage(
            { action: "getConversationMessage", origin: window.location.origin,
             message: chatTrigger.conversation_message},
            "*"
        );
      }
    }

    const dotIconStyle = document.getElementById('dot-icon-style');

    if (iframe.style.opacity == 1) {
      iframe.style.transform = "scale(0)";
      iframe.style.opacity = "0";
      iframe.style.pointerEvents = 'none';
      resetWidgetChatButtonWidthWhenNecessary(widgetData);

      if (smallScreen) {
        toggleBodyScroll(true);
        // Reset body positioning when closing
        document.body.style.position = "";
        document.body.style.overflow = "";
        document.body.style.inset = "";
        document.body.style.margin = "";
        // Note: This will overwrite any existing inline background-color on body
        // When resetting, we use empty string which reverts to CSS cascade
        // We keep it simple rather than storing/restoring original values because:
        // - Very few sites set body background via inline styles
        // - Chat widget is temporary overlay, not permanent page modification
        // - Complexity of storing/restoring all affected styles isn't worth the edge case
        document.body.style.backgroundColor = "";
      }
      if (dotIconStyle) {
        dotIconStyle.disabled = false;
      }
      // Swap icons
      innerIcon.style.display = "block";
      closeIcon.style.display = "none";
    } else {
      iframe.style.transform = "scale(1)";
      iframe.style.opacity = "1";
      iframe.style.pointerEvents = 'all';
      iframe.contentWindow.postMessage(
        { action: "scrollToBottom", origin: window.location.origin },
        "*"
      );
      if (smallScreen) {
        toggleBodyScroll(false);
        document.body.style.position = "fixed";
        document.body.style.inset = "0px";
        document.body.style.margin = "0px";
        document.body.style.backgroundColor = "#fafafa";
      }
      if (dotIconStyle) {
        dotIconStyle.disabled = true;
      }
      hideDotIconContent();
      // Swap icons
      innerIcon.style.display = "none";
      closeIcon.style.display = "block";
    }
  }

  function createLoadingSpinner(chatBubbleIcon, widgetData) {
    const color = widgetData.bubble_icon_type === 'type_bar' ? typeBarAccentColor : '#ffffff';
    // Create loading spinner
    const loaderSpan = document.createElement('span');
    loaderSpan.className = 'widget-chat-loader';

    // Append loading spinner
    chatBubbleIcon.appendChild(loaderSpan);

    // Create style element
    const style = document.createElement('style');
    style.innerHTML = `
      .widget-chat-loader {
        width: 24px;
        height: 24px;
        border: 3px solid ${color};
        border-bottom-color: transparent;
        border-radius: 50%;
        display: inline-block;
        box-sizing: border-box;
        animation: rotation 1s linear infinite;
      }

      @keyframes rotation {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    `;

    // Append style to the document's head
    document.head.appendChild(style);

    return loaderSpan;
  }

  function setWidgetChatButtonWidthWhenNecessary(widgetData) {
    const widgetChatButton = document.getElementById('widget-chat-button');

    if (widgetData.bubble_icon_type === 'type_bar') {
      widgetChatButton.style.width = "68px";
      widgetChatButton.style.height = "68px";
    }
  }

  function resetWidgetChatButtonWidthWhenNecessary(widgetData) {
    const widgetChatButton = document.getElementById('widget-chat-button');

    if (widgetData.bubble_icon_type === 'type_bar') {
      widgetChatButton.style.width = "auto";
      widgetChatButton.style.height = "auto";
    }
  }

  function createChatbotIframe(
    widgetData,
    url,
    chatBubbleSizeDifference,
    chatBubbleContainer,
    chatTrigger,
    chatBubbleIcon,
    innerIcon,
    closeIcon,
    visitorWidth,
    smallScreen
  ) {
    const widgetHorizontal = widgetData.widget_horizontal;
    const widgetVertical = widgetData.widget_vertical;
    const widgetCorner = widgetData.widget_position_corner;
    let chatbotIframe = document.getElementById('zipchat-iframe');

    setWidgetChatButtonWidthWhenNecessary(widgetData);

    if (!chatbotIframe) {
      innerIcon.style.display = "none";

      const urlObject = new URL(url);
      urlObject.searchParams.append('visitor_width', visitorWidth);
      url = urlObject.toString();

      // Show loading spinner
      const loaderSpan = createLoadingSpinner(chatBubbleIcon, widgetData);

      chatbotIframe = document.createElement('iframe');
      chatbotIframe.setAttribute('id', 'zipchat-iframe');
      chatbotIframe.classList.add("zipchat-iframe");
      chatbotIframe.src = url;
      chatbotIframe.style.maxheight = '700px';
      chatbotIframe.style.border = 'none';
      chatbotIframe.style.opacity = "0"
      chatbotIframe.style.transform = "scale(0)";
      chatbotIframe.style.position = "fixed";

      if (widgetData.bubble === 'whatsapp') {
        chatbotIframe.style.height = "520px"
      } else {
        chatbotIframe.style.height = `min(704px, 100% - ${84 + widgetVertical}px - ${chatBubbleSizeDifference}px)`;
      }

      chatbotIframe.style.pointerEvents = 'none';
      chatbotIframe.style.fontSize = '16px';
      chatbotIframe.style.boxShadow = "0 6px 6px 0 rgba(0,0,0,.02),0 8px 24px 0 rgba(0,0,0,.12)";
      chatbotIframe.style.transformOrigin = widgetCorner.replace('-',' ');
      chatbotIframe.style.transition = "transform 0.3s cubic-bezier(0, 1.2, 1, 1), opacity 0.2s ease-out";

      if (smallScreen) {
        chatbotIframe.style.top = '0';
        chatbotIframe.style.bottom = '0';
        chatbotIframe.style.width = '100%';
        chatbotIframe.style.height = '100%';
        chatbotIframe.style.zIndex = widgetData.z_index;
      } else {
        const vertical = `${widgetVertical + 70 + chatBubbleSizeDifference}px`;

        if (widgetCorner.includes('bottom')) {
          chatbotIframe.style.bottom = vertical;
        } else {
          chatbotIframe.style.top = vertical;
        }

        chatbotIframe.style.width = '400px';

        const horizontal = `${widgetHorizontal}px`;

        if (widgetCorner === 'bottom-center') {
          chatbotIframe.style.width = '600px';
          chatbotIframe.style.left = '50%';
          chatbotIframe.style.marginLeft = '-300px';
        } else if (widgetCorner.includes('right')) {
          chatbotIframe.style.right = horizontal;
        } else {
          chatbotIframe.style.left = horizontal;
        }

        chatbotIframe.style.zIndex = widgetData.z_index;
        chatbotIframe.style.borderRadius = "24px"
      }
      // Hide the spinner when the iframe has finished loading
      document.body.appendChild(chatbotIframe);
      chatbotIframe.onload = function() {
        // Hide loading spinner
        chatBubbleIcon.removeChild(loaderSpan);
        handleIframe(
          chatbotIframe, chatBubbleContainer, chatTrigger, innerIcon, closeIcon, widgetData, smallScreen
        )
      };
    } else {
      handleIframe(
        chatbotIframe, chatBubbleContainer, chatTrigger, innerIcon, closeIcon, widgetData, smallScreen
      )
    }
  }

  function modernWhatsappIcon(size, backgroundColor, stroke = '#ffffff') {
    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('id', 'bubble-icon');
    svg.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
    if (backgroundColor) {
      svg.setAttribute('fill', backgroundColor);
    }
    svg.setAttribute('viewBox', '0 0 35 35');
    svg.setAttribute('width', `${size}px`);
    svg.setAttribute('height', `${size}px`);

    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    path.setAttribute('fill-rule', 'evenodd');
    path.setAttribute('clip-rule', 'evenodd');
    path.setAttribute('d', 'M29.9003 5.08601C26.6106 1.80788 22.2353 0.00166318 17.5735 0C7.96746 0 0.149573 7.77954 0.14623 17.342C0.144559 20.3989 0.947573 23.3826 2.47255 26.0122L0 35L9.23841 32.5884C11.7836 33.9705 14.6497 34.6981 17.566 34.699H17.5735C27.1779 34.699 34.9967 26.9186 35 17.3561C35.0017 12.7217 33.1909 8.36498 29.9003 5.08684V5.08601ZM17.5735 31.7701H17.5677C14.9689 31.7693 12.4196 31.074 10.1952 29.761L9.66624 29.4484L4.18386 30.8795L5.647 25.5597L5.30272 25.0142C3.85296 22.7191 3.08671 20.0662 3.08838 17.3429C3.09172 9.39532 9.58936 2.92886 17.5794 2.92886C21.4482 2.93053 25.0848 4.43155 27.8197 7.15668C30.5546 9.88098 32.0595 13.5034 32.0579 17.3545C32.0545 25.3029 25.5569 31.7693 17.5735 31.7693V31.7701ZM25.5184 20.9744C25.083 20.7574 22.9423 19.7095 22.5428 19.5649C22.1434 19.4201 21.8535 19.3478 21.5635 19.7819C21.2736 20.216 20.4388 21.1923 20.1848 21.4808C19.9308 21.7702 19.6767 21.806 19.2413 21.5889C18.8061 21.3719 17.4031 20.9145 15.7394 19.4384C14.4451 18.2891 13.571 16.8705 13.317 16.4364C13.063 16.0023 13.2903 15.7678 13.5075 15.5524C13.703 15.3578 13.9428 15.046 14.1609 14.7932C14.3791 14.5403 14.4509 14.3591 14.5963 14.0705C14.7417 13.7811 14.669 13.5284 14.5604 13.3113C14.4517 13.0942 13.5811 10.9612 13.2176 10.0938C12.8641 9.24896 12.5048 9.36372 12.2382 9.34958C11.9842 9.3371 11.6943 9.33462 11.4035 9.33462C11.1127 9.33462 10.6414 9.44272 10.242 9.87682C9.84258 10.3109 8.71783 11.3595 8.71783 13.4917C8.71783 15.6239 10.2779 17.6855 10.496 17.9749C10.7141 18.2643 13.5668 22.6409 17.9345 24.5187C18.9732 24.9652 19.7845 25.2321 20.4171 25.4317C21.46 25.7619 22.4091 25.7153 23.1595 25.6039C23.996 25.4791 25.7357 24.5552 26.0983 23.5432C26.461 22.5311 26.461 21.6629 26.3524 21.4825C26.2438 21.302 25.953 21.1931 25.5176 20.976L25.5184 20.9744Z');
    path.setAttribute('fill', stroke);

    svg.appendChild(path);

    return svg;
  }

  // Create modern chat icon svg
  function modernZipchatIcon(size, color = '#ffffff') {
    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('id', 'bubble-icon');
    svg.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
    svg.setAttribute('fill', color);
    svg.setAttribute('viewBox', '0 0 21 25');
    svg.setAttribute('width', `${size}px`);
    svg.setAttribute('height', `${size}px`);

    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    path.setAttribute('fill-rule', 'evenodd');
    path.setAttribute('clip-rule', 'evenodd');
    path.setAttribute('d', 'M3.60412 0H10.466C10.466 5.74692 5.77465 10.4158 0 10.4158V3.58681C0 1.60705 1.61481 0 3.60412 0ZM10.47 0H15.697C18.5843 0 20.932 2.33243 20.932 5.20589C20.932 8.07935 18.5884 10.4118 15.701 10.4118H10.47V0ZM10.466 10.4216V20.726C10.5239 15.0284 15.1888 10.4175 20.9315 10.4175V20.8172H20.9322V25.0012C18.7149 22.0639 17.1702 20.975 11.7682 20.8333H10.466V20.8334H5.235C2.34767 20.8334 0.00398982 18.501 0.00398982 15.6275C0.00398982 12.754 2.34767 10.4216 5.235 10.4216H10.466Z');
    path.setAttribute('fill', color);

    svg.appendChild(path);

    return svg;
  }

  // Create classic chat icon svg
  function classicZipchatIcon(size) {
    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('id', 'bubble-icon');
    svg.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
    svg.setAttribute('fill', 'none');
    svg.setAttribute('viewBox', '0 0 24 24');
    svg.setAttribute('stroke-width', '1.5');
    svg.setAttribute('stroke', '#ffffff');
    svg.setAttribute('width', `${size}px`);
    svg.setAttribute('height', `${size}px`);
    svg.setAttribute('style', `width:${size}px;height:${size}px;fill:none;`);

    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    path.setAttribute('stroke-linecap', 'round');
    path.setAttribute('stroke-linejoin', 'round');
    path.setAttribute('d', 'M12 20.25c4.97 0 9-3.694 9-8.25s-4.03-8.25-9-8.25S3 7.444 3 12c0 2.104.859 4.023 2.273 5.48.432.447.74 1.04.586 1.641a4.483 4.483 0 01-.923 1.785A5.969 5.969 0 006 21c1.282 0 2.47-.402 3.445-1.087.81.22 1.668.337 2.555.337');
    svg.setAttribute('fill', 'none');

    svg.appendChild(path);

    return svg;
  }

  // Create custom chat icon
  function customZipchatIcon(bubbleIconUrl) {
    const img = document.createElement('img');
    img.setAttribute('id', 'bubble-icon');
    img.setAttribute('src', bubbleIconUrl);
    img.setAttribute('alt', 'Custom chat icon');
    img.setAttribute('width', '103%');
    img.setAttribute('height', '103%');

    return img;
  }

  function typeBarIcon(widgetData, bubbleIcon) {
    const fragment = document.createRange().createContextualFragment(
      `
        <style>
          input::placeholder {
            color: ${typeBarAccentColor};
          }

          .glow-wrapper {
            position: relative;
            width: 300px;
          }

          .glow-wrapper::before {
            content: "";
            position: absolute;
            inset: -1px;
            border-radius: 9999px;
            background: linear-gradient(270deg, ${typeBarGlowColors});
            background-size: 600% 600%;
            opacity: ${typeBarGlowOpacity};
            animation: glow 6s ease infinite;
            box-shadow:
              0 0 8px rgba(255, 126, 179, 0.15),
              0 0 16px rgba(142, 84, 233, 0.1),
              0 0 24px rgba(71, 118, 230, 0.05);
            z-index: 0;
            -webkit-border-radius: 9999px;
          }

          .glow-wrapper::after {
            content: "";
            position: absolute;
            inset: -1px;
            border-radius: 9999px;
            background: linear-gradient(270deg, ${typeBarGlowColors});
            background-size: 600% 600%;
            animation: glow 6s ease infinite;
            filter: blur(3px);
            /* Force hardware acceleration in Safari */
            transform: translate3d(0, 0, 0);
            -webkit-transform: translate3d(0, 0, 0);
            z-index: -1;
            opacity: ${typeBarGlowOpacity};
          }

          /* avoid the glow effect inside the bubble (just around the border) */
          .glow-wrapper::before,
          .glow-wrapper::after {
            -webkit-mask:
              linear-gradient(#fff 0 0) content-box,
              linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            padding: 2px; /* thickness of glow ring */
            box-sizing: border-box; /* needed for padding+inset */
          }

          @keyframes glow {
            0% {
              background-position: 0% 50%;
            }

            50% {
              background-position: 100% 50%;
            }

            100% {
              background-position: 0% 50%;
            }
          }

          /* Additional Safari-specific fixes */
          @supports (-webkit-appearance: none) {
            .glow-wrapper::before {
              /* Stronger blur alternative for webkit browsers */
              filter: blur(4px);
              -webkit-filter: blur(4px);
              /* Add backdrop filter for better Safari support */
              backdrop-filter: blur(1px);
              -webkit-backdrop-filter: blur(1px);
            }
          }
        </style>

        <div class="glow-wrapper" id="bubble-icon">
          <div id="type-bar" style="display: flex; align-items: center; justify-content: space-between; gap: 3px; background-color: #ffffff; border-radius: 9999px; padding: 16px;">
            <div style="display: flex; align-items: center; gap: 2px;">
              <div id="inner-bubble-icon"></div>

              <input type="text" placeholder="${widgetData.placeholder_message}" style="border: none; outline: none; box-shadow: none; max-width: 190px; font-size: 14px; padding-left: 9px; margin-bottom: 0; background-color: #ffffff;">
            </div>

            <div class="invalid" style="display: flex;">
              <svg width="36" height="36" viewBox="0 0 36 36" fill="currentColor"
                xmlns="http://www.w3.org/2000/svg" style="color: #E4E4E5">
                <circle cx="18" cy="18" r="18" fill="currentColor"/>
                <path fill-rule="evenodd" clip-rule="evenodd" d="M17.7222 25.2222C17.262 25.2222 16.8889 24.8491 16.8889 24.3888L16.8889 13.6226L13.8671 16.6447C13.5416 16.9702 13.014 16.9702 12.6886 16.6448C12.3631 16.3194 12.3631 15.7917 12.6885 15.4663L17.1329 11.0214C17.2892 10.8651 17.5012 10.7773 17.7222 10.7773C17.9432 10.7773 18.1552 10.8651 18.3115 11.0214L22.756 15.4663C23.0814 15.7917 23.0813 16.3194 22.7559 16.6448C22.4304 16.9702 21.9028 16.9702 21.5774 16.6447L18.5556 13.6226L18.5556 24.3888C18.5556 24.8491 18.1825 25.2222 17.7222 25.2222Z" fill="#ffffff"/>
              </svg>
            </div>
          </div>
        </div>
      `
    );
    fragment.querySelector('#inner-bubble-icon').replaceWith(bubbleIcon)
    return fragment
  }

  function createChatIcon(widgetData, size) {
    const typeBarIconSize = 18;

    if (widgetData.bubble === 'whatsapp') {
      if (widgetData.bubble_icon_type === 'type_bar') {
        return typeBarIcon(widgetData, modernWhatsappIcon(typeBarIconSize, undefined, typeBarAccentColor));
      } else {
        return modernWhatsappIcon(size, widgetData.color);
      }
    } else {
      if (widgetData.bubble_icon_type === 'type_bar') {
        return typeBarIcon(widgetData, modernZipchatIcon(typeBarIconSize, typeBarAccentColor));
      } else if (widgetData.bubble_icon_type === 'modern') {
        return modernZipchatIcon(size);
      } else if (widgetData.bubble_icon_type === 'classic') {
        return classicZipchatIcon(size);
      } else if (widgetData.bubble_icon_type === 'custom') {
        return customZipchatIcon(widgetData.bubble_icon_url);
      }
    }
  }

  function addDotIcon(widgetData, activeCampaign, size) {
    if (widgetData.bubble_icon_type === 'type_bar' && !activeCampaign) {
      return;
    }
    // ::before content can only be added via CSS
    // the properties with `var()` have their values changed when there is a proactive campaign
    const style = document.createElement('style');
    style.setAttribute('id', 'dot-icon-style');
    const right = widgetData.bubble_icon_type === 'type_bar' ? '1%' : '4%';
    const color = widgetData.dot_color;
    const defaultDotIconDisplay = widgetData.bubble_icon_type === 'type_bar' ? 'none' : 'block';

    style.textContent = `
      #widget-chat-button::before {
        display: var(--dot-icon-display, ${defaultDotIconDisplay});
        content: var(--dot-icon-content, "");
        color: #ffffff;
        font-size: 12px;
        text-align: center;
        line-height: var(--dot-icon-line-height, 100%);
        position: absolute;
        top: 4%;
        right: var(--dot-icon-right, ${right});
        background: ${color};
        border-radius: 50%;
        padding-left: 1px;
        font-weight: 800;
        z-index: 10;
        font-family: sans-serif;
        width: var(--dot-icon-size, ${size}px);
        height: var(--dot-icon-size, ${size}px);
      }
    `;
    document.head.appendChild(style);
  }

  function linkifyMessage(text) {
    const urlRegex = /https:\/\/[^\s]+/g;
    return text.replace(urlRegex, function(url) {
      return '<a href="' + url + '">' + url + '</a>';
    });
  }

  function chatPreviewHtml(widgetData) {
    const chatTrigger = widgetData.chat_trigger
    const imageElement = widgetData.photo_url ? `
      <div style="flex-shrink: 0; margin-right: 8px; ${widgetData.bubble ==  'whatsapp' ? 'display: none;' : ''}">
        <img id="photo-preview" alt="Photo preview" style="border-radius: 9999px; max-height: 32px; max-width: 32px;" width="32" height="32" data-chat-bot-show-target="photoSmallPreview" src="${widgetData.photo_url}">
      </div>` : '';

    const gapStyle = widgetData.photo_url ? 'gap: 12px;' : '';

    return `
      <div style="display: flex; align-items: flex-start;">
        ${imageElement}
        <div style="flex-grow: 1;">
          <div id="brand-name" style="padding: 4px 0; background-color: #ffffff; font-family: sans-serif;">
            <div style="display: flex; align-items: center; ${gapStyle};">
              <div style="flex: 1;">
                <div style="line-height: 16px;">
                  <p style="margin: 0; font-size: 10px; font-weight: 400; color: #1D1D1D" data-chat-bot-show-target="brandNameSmallPreview">
                    ${widgetData.brand_name}
                  </p>
                </div>
              </div>
              <div style="line-height: 16px; display: flex; color: #bdbdbd;justify-content: flex-end; cursor: pointer;" id="close-preview-message">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                  <path d="M0 12C0 5.37258 5.37258 0 12 0C18.6274 0 24 5.37258 24 12C24 18.6274 18.6274 24 12 24C5.37258 24 0 18.6274 0 12Z" fill="#F4F4F4"/>
                  <path d="M15.7806 16.7908C16.0596 17.0697 16.5118 17.0697 16.7908 16.7908C17.0697 16.5118 17.0697 16.0596 16.7908 15.7806L13.0102 12L16.7908 8.21936C17.0697 7.94042 17.0697 7.48816 16.7908 7.20921C16.5118 6.93026 16.0596 6.93026 15.7806 7.20921L12 10.9898L8.21936 7.20921C7.94042 6.93026 7.48816 6.93026 7.20921 7.20921C6.93026 7.48816 6.93026 7.94042 7.20921 8.21936L10.9898 12L7.20921 15.7806C6.93026 16.0596 6.93026 16.5118 7.20921 16.7908C7.48816 17.0697 7.94042 17.0697 8.21936 16.7908L12 13.0102L15.7806 16.7908Z" fill="#000000"/>
                </svg>
              </div>
            </div>
          </div>

          <div style="width: fit-content; line-height: 21px; letter-spacing: 0.2px; font-family: sans-serif; color: #000; font-size: 14px; background-color: #F4F4F4; padding: 8px 12px; border-radius: 12px;" data-chat-bot-show-target="welcomeSmallPreviewMessageText">
            ${chatTrigger?.popup_message ? linkifyMessage(chatTrigger.popup_message) : ''}
          </div>
        </div>
      </div>
    `
  }

  function createCloseIcon(innerIconSize, widgetData) {
    const crossSvg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
    crossSvg.setAttribute("xmlns", "http://www.w3.org/2000/svg");
    crossSvg.setAttribute("fill", "none");
    crossSvg.setAttribute("viewBox", "0 0 24 24");
    crossSvg.setAttribute("stroke-width", "1.5");
    crossSvg.setAttribute("stroke", "#ffffff");
    if (widgetData.bubble_icon_type === 'type_bar') {
      crossSvg.setAttribute("stroke-width", "2");
      crossSvg.setAttribute("stroke", typeBarAccentColor);
    }
    crossSvg.setAttribute("width", `${innerIconSize}px`);
    crossSvg.setAttribute("height", `${innerIconSize}px`);

    const crossPath1 = document.createElementNS("http://www.w3.org/2000/svg", "path");
    crossPath1.setAttribute("stroke-linecap", "round");
    crossPath1.setAttribute("stroke-linejoin", "round");
    crossPath1.setAttribute("d", "M6 18L18 6M6 6l12 12");

    crossSvg.appendChild(crossPath1);

    return crossSvg;
  }

  function createChatBubbleButton(widgetData, chatBubbleContainer, activeCampaign, shouldCenterBubble) {
    const chatBubbleButton = document.createElement('div');
    chatBubbleButton.setAttribute('id', 'widget-chat-button');
    chatBubbleButton.style.position = 'relative';
    chatBubbleButton.style.borderRadius = '50%';
    chatBubbleButton.style.backgroundColor = widgetData.color;
    chatBubbleButton.style.boxShadow = 'rgba(0, 0, 0, 0.2) 0px 4px 8px 0px';
    chatBubbleButton.style.cursor = 'pointer';
    chatBubbleButton.style.transition = 'all 0.2s ease-in-out 0s';

    const bubbleSizeMap = {
      'small': 48,
      'medium': 64,
      'large': 80
    };
    const bubbleDotSizeMap = {
      'small': 12,
      'medium': 12,
      'large': 16
    };
    document.querySelector('body').style.setProperty(
      '--widget-size', `${widgetData.widget_size}`
    );
    document.querySelector('body').style.setProperty(
      '--widget-bubble-icon-type', `${widgetData.bubble_icon_type}`
    );

    if (widgetData.bubble_icon_type === 'type_bar') {
      chatBubbleButton.style.backgroundColor = '#ffffff';
      const style = document.createElement('style');

      style.textContent = `
        #widget-chat-button::after {
          content: "";
          position: absolute;
          inset: -1px;
          border-radius: 9999px;
          background: linear-gradient(270deg, ${typeBarGlowColors});
          background-size: 600% 600%;
          animation: glow 6s ease infinite;
          filter: blur(3px);
          /* Force hardware acceleration in Safari */
          transform: translate3d(0, 0, 0);
          -webkit-transform: translate3d(0, 0, 0);
          z-index: -1;
          opacity: ${typeBarGlowOpacity};
        }

        @keyframes glow {
          0% {
            background-position: 0% 50%;
          }

          50% {
            background-position: 100% 50%;
          }

          100% {
            background-position: 0% 50%;
          }
        }
      `;
      document.head.appendChild(style);
    } else {
      chatBubbleButton.style.width = `${bubbleSizeMap[widgetData.widget_size]}px`;
      chatBubbleButton.style.height = `${bubbleSizeMap[widgetData.widget_size]}px`;
    }

    addDotIcon(widgetData, activeCampaign, bubbleDotSizeMap[widgetData.widget_size]);

    const widgetCorner = widgetData.widget_position_corner;
    if (shouldCenterBubble) {
      chatBubbleContainer.style.left = '50%';
      chatBubbleContainer.style.transform = 'translateX(-50%)';
      chatBubbleContainer.style.bottom = `${widgetData.widget_vertical}px`;
    } else {
      const horizontalPosition = widgetCorner.includes("right") ? "right" : "left";
      const verticalPosition = widgetCorner.includes("bottom") ? "bottom" : "top";

      chatBubbleContainer.style[horizontalPosition] = `${widgetData.widget_horizontal}px`;
      chatBubbleContainer.style[verticalPosition] = `${widgetData.widget_vertical}px`;
    }

    return chatBubbleButton;
  }

  // Append the token to the chatbot URL
  function generateRandomString(length) {
    var result = '';
    var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    for (var i = 0; i < length; i++) {
      result += characters.charAt(Math.floor(Math.random() * characters.length));
    }
    return result;
  }

  function createChatPreviewMessage(widgetData, chatBubbleSizeDifference, shouldCenterBubble) {
    const chatPreviewMessage = document.createElement('div');
    chatPreviewMessage.setAttribute('id', 'chat-preview-message');
    chatPreviewMessage.style.paddingTop = '12px';
    chatPreviewMessage.style.paddingBottom = '12px';
    chatPreviewMessage.style.fontFamily = 'sans-serif;'
    chatPreviewMessage.style.color = '#000000'
    chatPreviewMessage.style.paddingLeft = '12px';
    chatPreviewMessage.style.paddingRight = '12px';
    chatPreviewMessage.style.boxShadow = 'rgba(0, 0, 0, 0.2) 0px 4px 8px 0px';
    const horizontalPreview = `${widgetData.widget_horizontal}px`;
    const widgetCorner = widgetData.widget_position_corner;

    if (widgetCorner.includes('right')) {
      chatPreviewMessage.style.right = horizontalPreview;
    } else {
      chatPreviewMessage.style.left = horizontalPreview;
    }
    const verticalPreview = widgetData.widget_vertical + 65 + chatBubbleSizeDifference;

    if (shouldCenterBubble) {
      chatPreviewMessage.style.left = '50%';
      chatPreviewMessage.style.marginLeft = '-150px';
      chatPreviewMessage.style.bottom = verticalPreview - 15 + 'px';
    } else if (widgetCorner.includes('bottom')) {
      chatPreviewMessage.style.bottom = verticalPreview + 'px';
    } else {
      chatPreviewMessage.style.top = verticalPreview + 'px';
    }
    chatPreviewMessage.style.width = '300px';
    chatPreviewMessage.style.maxWidth = '300px';
    chatPreviewMessage.style.backgroundColor = '#ffffff';
    chatPreviewMessage.style.height = 'auto';
    chatPreviewMessage.style.position = 'fixed';
    chatPreviewMessage.style.zIndex = widgetData.z_index;
    chatPreviewMessage.style.display = "none"
    chatPreviewMessage.style.borderRadius = "24px"
    chatPreviewMessage.style.transition = "transform 0.3s cubic-bezier(0, 1.2, 1, 1), opacity 0.2s ease-out";
    chatPreviewMessage.innerHTML = chatPreviewHtml(widgetData)

    return chatPreviewMessage;
  }

  function loadWidget() {
    var scriptTag = document.querySelector('script[src*="zipchat.js"]');
    var widgetToken = new URL(scriptTag.src).searchParams.get('id');
    let widgetConfigurationUrl, chatbotUrl, baseUrl;

    const currentUrl = window.location.href;

    // if current url include params zipchat-preview=true remove the chatPreviewMessageHidden flag
    if (currentUrl.includes('zipchat-preview=true')) {
      console.log('zipchat-preview=true');
      localStorage.removeItem('chatPreviewMessageHidden');
    }

    // Not running as Shopify theme app extension
    if (widgetToken) {
      let baseUrl = scriptTag.src.replace(`/widget/zipchat.js?id=${widgetToken}`, '/widget_data');
      // Case when shopify is loading the script tag, we need to remove the &shop parameter
      const shopParamIndex = baseUrl.indexOf('&shop=');
      if (shopParamIndex !== -1) {
        baseUrl = baseUrl.substring(0, shopParamIndex);
      }

      widgetConfigurationUrl = new URL(baseUrl);
      widgetConfigurationUrl.searchParams.append('widget_token', widgetToken);
    } else {
      widgetConfigurationUrl = new URL(window.location.origin + '/apps/zipchat/widget/configuration');
    }
    widgetConfigurationUrl.searchParams.append('current_url', currentUrl);

    const visitorWidth = window.innerWidth;
    widgetConfigurationUrl.searchParams.append('visitor_width', visitorWidth);
    const smallScreen = visitorWidth <= 768;

    fetch(widgetConfigurationUrl.toString(), {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      }
    })
      .then(response => response.json())
      .then(data => {
        var widgetData = data;
        const chatTrigger = widgetData.chat_trigger
        const activeCampaign = !!chatTrigger?.popup_message
        const shouldCenterBubble = (
          widgetData.widget_position_corner === 'bottom-center'
            || (smallScreen && widgetData.bubble_icon_type === 'type_bar')
        )

        if (widgetData.widget == false) {
          return
        }

        const sizeMap = {
          'small': 0,
          'medium': 10,
          'large': 20
        };
        const chatBubbleSizeDifference = sizeMap[widgetData.widget_size] || 0;
        const chatPreviewMessage = createChatPreviewMessage(
          widgetData, chatBubbleSizeDifference, shouldCenterBubble
        )

        // Not running as Shopify theme app extension
        if (widgetToken) {
          baseUrl = scriptTag.src.replace(`/widget/zipchat.js?id=${widgetToken}`, '/widget');
          // Case when shopify is loading the script tag, we need to remove the &shop parameter
          const shopParamIndex = baseUrl.indexOf('&shop=');
          if (shopParamIndex !== -1) {
            baseUrl = baseUrl.substring(0, shopParamIndex);
          }

          chatbotUrl = new URL(baseUrl);
        } else {
          chatbotUrl = new URL(`${data.api_base}/widget`);
        }
        chatbotUrl.searchParams.append('current_url', currentUrl);

        var visitor_token = localStorage.getItem('visitor_token');
        if (!visitor_token) {
          visitor_token = generateRandomString(20);
          localStorage.setItem('visitor_token', visitor_token);
        }

        chatbotUrl.searchParams.append('visitor_token', visitor_token);
        chatbotUrl.searchParams.append('widget_token', data.widget_token);

        const chatBubbleContainer = document.createElement('div');
        chatBubbleContainer.setAttribute('id', 'widget-chat-container');
        chatBubbleContainer.style.position = 'fixed';
        chatBubbleContainer.style.transition = 'all 0.2s ease-in-out 0s';
        chatBubbleContainer.style.zIndex = widgetData.z_index;

        const chatBubbleButton = createChatBubbleButton(
          widgetData, chatBubbleContainer, activeCampaign, shouldCenterBubble
        )

        var chatBubbleIcon = document.createElement('div');
        chatBubbleIcon.style.display = 'flex';
        chatBubbleIcon.style.alignItems = 'center';
        chatBubbleIcon.style.justifyContent = 'center';
        chatBubbleIcon.style.width = '100%';
        chatBubbleIcon.style.height = '100%';
        chatBubbleIcon.style.zIndex = widgetData.z_index;
        chatBubbleIcon.style.borderRadius = '100%';
        // necessary for the glow effect appears around the bubble
        if (widgetData.bubble_icon_type === 'type_bar') {
          chatBubbleIcon.style.backgroundColor = '#ffffff';
        } else {
          chatBubbleIcon.style.overflow = 'hidden';
        }

        const innerIconSizeMap = {
          'small': 24,
          'medium': 32,
          'large': 40
        };
        const innerIconSize = innerIconSizeMap[widgetData.widget_size];

        let innerIcon = createChatIcon(widgetData, innerIconSize);
        const closeIcon = createCloseIcon(innerIconSize, widgetData)
        // Append the SVG to the chat bubble icon
        chatBubbleIcon.appendChild(innerIcon);

        // Append the cross svg that we will hide and show
        closeIcon.style.display = "none";
        chatBubbleIcon.appendChild(closeIcon)

        // Append the chat bubble icon to the chat bubble button
        chatBubbleButton.appendChild(chatBubbleIcon);

        // Append the chat bubble button to the user's website
        document.body.appendChild(chatBubbleContainer);
        chatBubbleContainer.appendChild(chatBubbleButton);

        innerIcon = document.getElementById('bubble-icon');

        document.querySelector("#widget-chat-button").addEventListener("mousedown", function (event) {
          event.stopPropagation();
          event.currentTarget.style.transform = "scale(0.7)";
        });

        document.querySelector("#widget-chat-button").addEventListener("mouseup", function (event) {
          event.stopPropagation();
          event.currentTarget.style.transform = "scale(1)";
        });

        if (!localStorage.getItem('chatPreviewMessageHidden') && activeCampaign) {
          chatBubbleContainer.appendChild(chatPreviewMessage);

          chatBubbleContainer.querySelector('#chat-preview-message').addEventListener("click", function (event) {
            if (event.target.nodeName === 'A') {
              return;
            }

            event.stopPropagation();
            var chatPreviewMessage = document.querySelector('#chat-preview-message');
            chatPreviewMessage.style.transform = "scale(0)";
            chatPreviewMessage.style.display = 'none'
            document.querySelector("#widget-chat-button").click();
          });

          function showChatPreviewMessage() {
            setDotIconContent();

            chatPreviewMessage.style.transform = "scale(1)";
            chatPreviewMessage.style.opacity = "1";
            chatPreviewMessage.style.display = "";
          }

          function hideChatPreviewMessage() {
            chatPreviewMessage.style.transform = "scale(0)";
            chatPreviewMessage.style.display = 'none'
            chatPreviewMessage.remove()
          }

          function showPreviewMessageByTime(delay, callback) {
            setTimeout(() => {
              callback();
            }, delay);
          }

          function showPreviewMessageByScrollPercentage(thresholdPercentage, callback){
            window.addEventListener('scroll', function() {
              const scrollTop = window.scrollY || document.documentElement.scrollTop;
              const windowHeight = window.innerHeight || document.documentElement.clientHeight;
              const documentHeight = document.documentElement.scrollHeight;

              const scrollPercentage = (scrollTop + windowHeight) / documentHeight * 100;

              if (scrollPercentage >= thresholdPercentage) {
                callback();
                window.removeEventListener('scroll', arguments.callee);
              }
            });
          }

          chatBubbleContainer.querySelector('#close-preview-message').addEventListener("click", function (event) {
            event.stopPropagation();
            hideChatPreviewMessage();

            // Set the localStorage flag to prevent showing the chat preview message again
            localStorage.setItem('chatPreviewMessageHidden', 'true');
          });

          if (!!chatTrigger && chatTrigger.setup_type == 'advanced'){
            if (chatTrigger.all_rules_met && (!!chatTrigger.show_after_scroll_percentage && !!chatTrigger.show_after_seconds)){
              showPreviewMessageByScrollPercentage(
                chatTrigger.show_after_scroll_percentage,
                () => showPreviewMessageByTime(chatTrigger.show_after_seconds * 1000, showChatPreviewMessage)
              )
            }
            else {
              if (!!chatTrigger.show_after_scroll_percentage){
                showPreviewMessageByScrollPercentage(chatTrigger.show_after_scroll_percentage, showChatPreviewMessage)
              }
              if (!!chatTrigger.show_after_seconds){
                showPreviewMessageByTime(chatTrigger.show_after_seconds * 1000, showChatPreviewMessage)
              }
            }
          }
          else {
            showPreviewMessageByTime(2000, showChatPreviewMessage)
          }
        }

        // Opening closing the chatbot when clicking on the widget button
        document.querySelector("#widget-chat-button").addEventListener("click", function (event) {
          event.stopPropagation();
          createChatbotIframe(
            widgetData,
            chatbotUrl.toString(),
            chatBubbleSizeDifference,
            chatBubbleContainer,
            chatTrigger,
            chatBubbleIcon,
            innerIcon,
            closeIcon,
            visitorWidth,
            smallScreen
          );
        });

        // On mobile, I added a 'x' to close the chatbot, because it's in the iframe, I need to do a post message
        window.addEventListener('message', function(event) {
          if (event.origin !== event.data.origin) {
            return;
          }
          const iframe = document.getElementById("zipchat-iframe");
          const dotIconStyle = document.getElementById('dot-icon-style');

          if (event.data.action === 'close-iframe') {
            iframe.style.transform = "scale(0)";
            iframe.style.opacity = "0";
            iframe.style.pointerEvents = 'none';
            resetWidgetChatButtonWidthWhenNecessary(widgetData);

            if (dotIconStyle) {
              dotIconStyle.disabled = false;
            }

            innerIcon.style.display = "block";
            closeIcon.style.display = "none";
            toggleBodyScroll(true)
            // Reset body positioning when closing
            document.body.style.position = "";
            document.body.style.overflow = "";
            document.body.style.inset = "";
            document.body.style.margin = "";
            document.body.style.backgroundColor = "";
          }
          if (event.data.action === 'remove-iframe') {
            iframe.remove()
            document.getElementById("widget-chat-button").remove()
          }
        });

        // If the clicked element is neither the chat button nor the iframe itself, close the iframe.
        window.addEventListener("click", function(event) {
          const iframe = document.getElementById("zipchat-iframe");
          const chatButton = document.getElementById("widget-chat-button");
          const dotIconStyle = document.getElementById('dot-icon-style');

          if (event.target !== chatButton && event.target !== iframe && iframe) {
            resetWidgetChatButtonWidthWhenNecessary(widgetData);
            iframe.style.transform = "scale(0)";
            iframe.style.opacity = "0";
            iframe.style.pointerEvents = 'none';
            innerIcon.style.display = "block";
            closeIcon.style.display = "none";
            if (dotIconStyle) {
              dotIconStyle.disabled = false;
            }
            toggleBodyScroll(true)

            // Reset body positioning when closing
            document.body.style.position = "";
            document.body.style.overflow = "";
            document.body.style.inset = "";
            document.body.style.margin = "";
            document.body.style.backgroundColor = "";
          }
        });

        window.zipchatWidgetLoaded = true;
      })
      .catch(error => {
        console.error('Error fetching data:', error);
      });
  }

  if (document.readyState === 'loading') {
    // If the document is still loading, wait for DOMContentLoaded
    document.addEventListener('DOMContentLoaded', function() {
      loadWidget();
      setupUrlChangeDetection();
    });
  } else {
    // If the document has already finished loading, we can run the function now
    loadWidget();
    setupUrlChangeDetection();
  }
})();
